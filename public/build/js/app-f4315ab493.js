angular.safeApply=function(e,n){e[e.$$phase||e.$root.$$phase?"$eval":"$apply"](n||function(){})},angular.isMobile=function(e){return/((iP([oa]+d|(hone)))|Android|WebOS|BlackBerry|windows (ce|phone))/i.test(e)}(navigator.userAgent||navigator.vendor||window.opera),angular.isOnline=function e(){var e=window.navigator&&window.navigator.onLine;return e},angular.storagePrefix=function(e){var n=["ymag",window.gid];return e&&e.length&&n.push(e),n.join(".")};var app=angular.module("app",["ngSanitize","LocalStorageModule"]);app.config(["localStorageServiceProvider","$httpProvider",function(e,n){var t=angular.storagePrefix();n.defaults.headers.common.Authorization="Bearer "+window.api_token,e.setPrefix(t),e.setStorageCookie(1,"/")}]),app.run(["$rootScope",function(e){window.onclick=function(n){0==$(n.target).closest("div.card-actions.dropdown.open").length&&0==$(n.target).closest("#cities-list").length&&e.$broadcast("cardbox.close")}}]),app.REWRITE_BASE="/","dev-your-morning.rainbowriders.dk"==location.host&&(app.REWRITE_BASE="/public/"),app.API_PREFIX=app.REWRITE_BASE+"api/v1",app.controller("CalendarController",["$scope","EventsService","localStorageService",function(e,n,t){function a(n){e.filter.calendar=angular.copy(n)}function r(){var n=e.calendars.filter(function(e){return!!e.primary})[0];a(n),o()}function o(){t.set("cal",JSON.stringify(angular.copy(e.filter.calendar)))}function i(){return e.loading?!1:(e.loading=!0,n.events(e.filter.calendar.id).then(function(n){e.events=n,e.loading=!1,e.hasEvents=Object.keys(n).length}))}e.loading=!1,e.filter={calendar:null},e.calendars=[],e.hasEvents=!1,e.events=[],e.init=function(n){e.calendars=n;var a;(a=t.get("cal"))?(a=JSON.parse(a),e.filter.calendar=a):r(),i()},e.savePreferences=function(e){o(),i().then(function(){e&&e()})},e.select=function(n){e.filter.calendar=angular.copy(n)},e.selected=function(n){return e.filter.calendar&&e.filter.calendar.id==n.id},e.cancel=function(n){e.filter.calendar=angular.copy(JSON.parse(t.get("cal"))),n&&n()}}]),app.controller("GmailController",["$scope","GmailService","$sce","localStorageService",function(e,n,t,a){function r(){e.query="";var n=[];return angular.forEach(["from","to","subject"],function(t,a,r){var o=e.filter[t];o.length&&n.push(t+": ("+o+")")}),e.query=n.join(" ").trim(),e.query}e.searchMode=!0,e.message=null,e.loading=!1,e.nextPageToken=null;var o,i=function(){return{from:"",to:"",subject:"",includeSpamTrash:!1}};(o=a.get("g_fltr"))||(o=JSON.stringify(i()),a.set("g_fltr",o)),e.filter=JSON.parse(o),e.messages=[],e.query=r(),e.savePreferences=function(n){return e.messages=[],e.nextPageToken=null,e.fetchMessages(n)},e.next=e.fetchMessages=function(t){if(e.loading)return!1;e.loading=!0,a.set("g_fltr",o=JSON.stringify(e.filter));var i={includeSpamTrash:!!e.filter.includeSpamTrash,q:r(),nextPageToken:e.nextPageToken};return n.fetchMessages(i).then(function(n){t&&t(),angular.safeApply(e,function(e){for(var t in n.messages)e.messages.push(n.messages[t]);e.nextPageToken=n.nextPage,e.loading=!1})})["catch"](function(){e.loading=!1})},e.fetchMessages(),e.isUnRead=function(e){return e.hasOwnProperty("labels")&&-1<e.labels.indexOf("UNREAD")},e.fullMessageUrl=function(e){return t.trustAsResourceUrl(app.API_PREFIX+"/gmail/messages/"+e+"/body")},e.toggleSearchMode=function(n,t){n||(e.filter=JSON.parse(o)),t&&t()},e.backToList=function(){e.message=null},e.readMessage=function(t){e.loading=!0,n.get(t).then(function(a){angular.safeApply(e,function(e){e.message=a,e.loading=!1;e.messages.filter(function(e){return e.id==t})[0];e.messages.map(function(a){if(a.id==t&&e.isUnRead(a)){var r=a.labels.indexOf("UNREAD");a.labels.splice(r,1),n.markAsRead(t)}return a})})})["catch"](function(){e.loading=!1})}}]),app.controller("QuoteController",["$scope","$http",function(e,n){e.quote={id:null,quote:"",author:""},e.loading=!1,e.fetchRandom=function(){return e.loading?!1:(e.loading=!0,void n.get(app.API_PREFIX+"/quotes/random").then(function(n){e.quote=n.data,e.loading=!1}))}}]),app.controller("RssController",["$scope","$timeout","localStorageService","FeedService","$q",function(e,n,t,a,r){function o(e){return window.lang+"."+e}function i(){return c(_.pluck(e.allFeeds,"id"))}function c(e){return e.map(function(e){return parseInt(e)})}function l(){var n,a=t.keys().indexOf(o("feeds"))>-1;f=[],a?(n=t.get(o("feeds")),n.length&&(f=c(n.split(",")))):f=i(),e.savedFeeds=angular.copy(f),u()}function s(){var n=r.defer();return e.loading||!f.length?n.resolve([]):(e.loading=!0,a.news(f).then(function(t){e.loading=!1,e.articles=t,n.resolve(t)})),n.promise}function u(){e.allChecked=f.length==e.allFeeds.length}e.loading=!1,e.allChecked=!1,e.allFeeds=[];var f=[];e.savedFeeds=[],e.articles=[],e.$watch("feeds",function(e,n){return e===n?!1:void u()},!0),e.toggleAll=function(e){f=1==e.target.checked?i():[]},e.init=function(n){e.allFeeds=n,l(),s()},e.savePreferences=function(n){return e.savedFeeds=c(f),t.set(o("feeds"),e.savedFeeds.join(",")),s().then(function(){n&&n()})},e.cancel=function(e){l(),e&&e()},e.trackUntrack=function(n){n=parseInt(n),e.trackable(n)?f=_.without(f,n):f.push(n)},e.trackable=function(e){return e=parseInt(e),-1!=_.indexOf(f,e)}}]),app.controller("SizerController",["$scope","$window",function(e,n){function t(){return $.browser.msie?.68:.8}var a=function(){var n=t(),a=$(window).height(),r=Math.round(a*n);angular.isMobile?(e.size1=200,e.size2=240,e.size3=150):(e.size1=Math.round(.35*r),e.size2=Math.round(.45*r),e.size3=r-(e.size1+e.size2)),e.resized=!0};setTimeout(a,100),$(window).on("resize",a)}]),app.controller("WeatherController",["$scope","$timeout","WeatherService","GeoService","localStorageService","$http",function(e,n,t,a,r,o){function i(n){o.get(app.API_PREFIX+"/geo/places?name="+n).then(function(n){var t=_.uniq(n.data.predictions)||[];e.cities=t})}function c(e,n){return e.address!==n.address&&e.address.length>=3}function l(){p(),e.filter=angular.copy(m)}function s(e){e&&e()}function u(){r.set("w_fltr",JSON.stringify(_.omit(e.filter,"address"))),m=angular.copy(e.filter)}function f(){return JSON.parse(r.get("w_fltr"))}function d(){return[e.filter.location.lat,e.filter.location.lng].join(",")}function g(n,t){a.lookup(n||a.getLatitude(),t||a.getLongitude()).then(function(n){p(),e.filter.address=n.formatted_address,u(),e.$emit("location.changed")})}function p(){S=!0,n(function(){S=!1},100)}var h,v=!1,m={units:"si",location:{},address:""};e.cities=[],e.filter=angular.copy(m),e.weather={},e.loading=!1;var S=!1;e.$watch("filter",function(e,n){return S||e===n?!1:(v=!0,c(e,n)&&i(e.address),void(S=!1))},!0),e.$on("location.changed",function(){t.fetch(d(),{units:e.filter.units}).then(function(n){e.weather=angular.extend(n,e.filter)})}),(h=f())?(e.filter=angular.copy(h),m=angular.copy(e.filter),g(h.location.lat,h.location.lng)):a.geolocate().then(function(n){e.filter.location={lat:n.getLatitude(),lng:n.getLongitude()},g()}),e.cancel=function(e){l(),s(e)},e.savePreferences=function(n){return v?e.loading?!1:(e.loading=!0,v&&e.filter.address.length?(v=!1,a.geocode(e.filter.address).then(function(t){t&&t.hasOwnProperty("geometry")&&(p(),e.filter=angular.extend(e.filter,{location:t.geometry.location}),u(),e.$emit("location.changed"),s(n)),e.loading=!1})):(e.$emit("location.changed"),s(n)),!1):!1},e.locationToCity=function(e){return e&&e.indexOf(",")?_.first(e.split(", ")):""},e.selectCity=function(n){p(),e.filter.address=n.description,e.cities=null},e.icon=function(){return app.REWRITE_BASE+"icons/w/"+e.weather.currently.icon+".png"}}]),app.directive("cardBox",["$timeout","$rootScope",function(e,n){return{restrict:"E",scope:{title:"@"},transclude:{actions:"?cardBoxActions",body:"cardBoxBody"},link:function(t,a){function r(){angular.safeApply(t,function(e){e.editable=!1})}t.editable=!1,e(function(){t.hasActions=!!a.find("card-box-actions").text().length}),t.switchEditableMode=function(e){t.editable=!t.editable,e&&e()},t.close=r,n.$on("cardbox.close",r)},templateUrl:app.REWRITE_BASE+"assets/templates/card-box.html"}}]),app.directive("eventIcon",[function(){return{restrict:"E",scope:null,link:function(e,n,t){var a=JSON.parse(t.event),r=null;a.birthday?r="ti-gift":a.allDay||(r="ti-alarm-clock"),e.icon=r},template:'<i ng-if="icon" class="{{ icon }}">&nbsp;</i>'}}]),app.factory("EventsService",["$http","$httpParamSerializer",function(e,n){var t={};return t.events=function(t){var a=n({c:t,t:(new Date).getTime(),tz:0});return e.get(app.API_PREFIX+"/calendar/events?"+a).then(function(e){return e.data.data})},t}]),app.factory("FeedService",["$http","$httpParamSerializer",function(e,n){var t={};return t.news=function(t){var a=n({ids:t.join(",")});return e.get(app.API_PREFIX+"/feed/news?"+a).then(function(e){return e.data.data})},t}]),app.factory("GeoService",["$q","$http",function(e,n){function t(){return r.setLocation(40.7127837,-74.0059413),r}function a(e){n.get(app.API_PREFIX+"/geo/ip").then(function(n){var a=n.data;a.cityName.length&&"-"!=a.cityName?(r.setLocation(a.latitude,a.longitude),e.resolve(r)):e.resolve(t())})["catch"](function(){e.resolve(t())})}var r={lat:null,lng:null};return r.setLocation=function(e,n){return r.lat=parseFloat(e),r.lng=parseFloat(n),r},r.getLatitude=function(){return this.lat},r.getLongitude=function(){return this.lng},r.geolocate=function(){var n=e.defer();return navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){r.setLocation(e.coords.latitude,e.coords.longitude),n.resolve(r)},function(){return a(n)}):n.resolve(t()),n.promise},r.geocode=function(e){return n.get(app.API_PREFIX+"/geo/code?loc="+e).then(function(e){return e.data.results[0]})},r.lookup=function(e,t){return n.get(app.API_PREFIX+"/geo/lookup?latlng="+[e,t].join(",")).then(function(e){return e.data.results[0]})},r}]),app.factory("GmailService",["$http","$httpParamSerializer",function(e,n){var t={};return t.fetchMessages=function(t){return e.get(app.API_PREFIX+"/gmail/messages?"+n(t)).then(function(e){return e.data})},t.get=function(n){return e.get(app.API_PREFIX+"/gmail/messages/"+n+"?include=body").then(function(e){return e.data})},t.markAsRead=function(n){return e.get(app.API_PREFIX+"/gmail/messages/"+n+"/touch")},t}]),app.factory("WeatherService",["$http","$httpParamSerializer",function(e,n){var t={};return t.fetch=function(t,a){var r=angular.extend({coords:t,units:"si"},a||{}),o=app.API_PREFIX+"/weather/get?"+n(r);return e.get(o).then(function(e){return e.data})},t}]);